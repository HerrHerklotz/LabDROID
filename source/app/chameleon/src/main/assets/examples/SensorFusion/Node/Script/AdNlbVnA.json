{"inputs":[["component","hw_sensor_Accelerometer","Data","stream"],["component","hw_sensor_Gyroscope","Data","stream"]],"label":"Fusion","outputs":[null],"position":{"x":243,"y":305},"typeName":"node/script","code":"const convert = 180/Math.PI\r\n\r\nlet start\r\nlet end = $now()\r\nlet oldPitch = 0\r\nlet angle = 0\r\nlet stableCount = 0\r\n\r\n\r\nwhile (true) {\r\n    const accel = $receive(0)\r\n        \r\n    const pitch = 0-Math.atan2(accel.x, Math.sqrt( accel.y * accel.y + accel.z * accel.z))*convert\r\n    \r\n    const gyro = $receive(1).y\r\n    start = end\r\n    end = $now()\r\n    \r\n    const dT = (end - start)/1000000000\r\n    \r\n    if (Math.abs(pitch-oldPitch) < 0.01) {\r\n        if (++stableCount == 5) {\r\n            // \"no motion\" in the last 3 measurements. \r\n            // -> Use the absolute accelerometer data.\r\n            angle = pitch\r\n            stableCount = 0\r\n        } else {\r\n            // \"motion\" detected.\r\n            // -> Use the relative gyrscope data.\r\n            angle += gyro*convert*dT\r\n        }\r\n    }\r\n    else\r\n        angle += gyro*convert*dT\r\n    \r\n    $out(0, angle)\r\n    \r\n    oldPitch = pitch\r\n}"}